version: v1.0

name: Build and test Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

#global_job_config:

  #prologue:
  #  commands:
  #    - echo $DOCKER_TOKEN | docker login --username "$DOCKER_USERNAME" --password-stdin

  #env_vars:
  #  - name: DOCKER_USERNAME
  #    value: sineverba
  #  - name: DOCKER_IMAGE
  #    value: cfhookbash

blocks:
  - name: Install dependencies
    skip:
      when: "true"
    #  when: "tag =~ '.*'"
    task:
      #prologue:
      #  commands:
      #    - sem-version node 12
      jobs:
        - name: 'Install'
          matrix:
            - env_var: NODE_VERSION
              values: [ "10", "11", "12", "13", "14" ]
          commands:
            - sem-version node $NODE_VERSION
            - node --version
            - checkout
            - cache restore
            - npm install
            - cache store

  - name: Test
    skip:
      when: "true"
    task:
      prologue:
        commands:
          - checkout
          - cache restore
      jobs:
        - name: Test
          matrix:
            - env_var: NODE_VERSION
              values: [ "10", "11", "12", "13", "14" ]
          commands:
            - sem-version node $NODE_VERSION
            - node --version
            - npm run test

  - name: Coverage
    skip:
      when: "true"
    task:
      prologue:
        commands:
          - checkout
          - cache restore
      jobs:
       - name: Coverage
          commands:
            - sem-version node 12
            - npm run cover
            - cat coverage/lcov.info | node_modules/coveralls/bin/coveralls.js

      secrets:
        - name: COVERALLS_SHORTFIELD_REPO_TOKEN
        
  - name: Deploy
    task:
      jobs:
        - name: Deploy
          commands:
            - sem-version node 12
            - checkout
            - npm build
            - npm publish

    secrets:
      - name: NPM_TOKEN

#promotions:
#  - name: Deploy
#    pipeline_file: deploy.yml
#    auto_promote:
#      when: "result = 'passed' and tag =~ '.*'"